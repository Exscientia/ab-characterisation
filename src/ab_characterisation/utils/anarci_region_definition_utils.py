from collections import defaultdict
from dataclasses import dataclass, field  # pylint: disable=C0302
from typing import Dict, List, Tuple


@dataclass
class ExtractedRegions:
    """
    Class to record numbered antibody sequence with region annotation
    """

    region_numbering: List[Tuple[Tuple[int, str], str, str]] = field(
        init=False, repr=False, default_factory=list
    )
    region_sequences: Dict[str, str] = field(
        init=False, repr=True, default_factory=lambda: defaultdict(str)
    )

    def add_residue(
        self, current_regions: str, amino_acid: str, residue: Tuple[int, str]
    ) -> None:
        """
        Function to record a numbered residue with region annotation
        Args:
            current_regions: name of the region e.g. cdrh1
            amino_acid: one letter amino acid letter
            residue: antibody numbered position e.g. (110, " ")

        Returns:

        """
        if self.region_numbering and self.region_numbering[-1][0][0] > residue[0]:
            raise AssertionError(
                f"Incorrect numbering. Previous residue cannot come"
                f" after the added one: {self.region_numbering[-1][0]} and {residue}"
            )
        self.region_numbering.append((residue, amino_acid, current_regions))
        self.region_sequences[current_regions] += (
            amino_acid if amino_acid != "-" else ""
        )


def define_imgt_regions() -> Dict[str, str]:
    """
    Antibody region definition according to imgt scheme
    """
    heavy_region = (
        "1" * 26 + "2" * 12 + "3" * 17 + "4" * 10 + "5" * 39 + "6" * 13 + "7" * 11
    )
    light_region = heavy_region
    assert len(heavy_region) == 128

    return {"H": heavy_region, "L": light_region}


def define_chothia_regions() -> Dict[str, str]:
    light_region = (
        "1" * 23 + "2" * 17 + "3" * 15 + "4" * 14 + "5" * 35 + "6" * 13 + "7" * 11
    )

    heavy_region = (
        "1" * 26 + "2" * 11 + "3" * 19 + "4" * 8 + "5" * 42 + "6" * 11 + "7" * 11
    )
    for reg in [light_region, heavy_region]:
        assert len(reg) == 128

    return {"H": heavy_region, "L": light_region}


def define_kabat_regions() -> Dict[str, str]:
    light_region = (
        "1" * 23 + "2" * 17 + "3" * 15 + "4" * 14 + "5" * 35 + "6" * 13 + "7" * 11
    )
    heavy_region = (
        "1" * 35 + "2" * 5 + "3" * 14 + "4" * 20 + "5" * 32 + "6" * 11 + "7" * 11
    )

    for reg in [light_region, heavy_region]:
        assert len(reg) == 128

    return {"H": heavy_region, "L": light_region}


def define_contact_regions() -> Dict[str, str]:
    light_region = (
        "1" * 35 + "2" * 7 + "3" * 9 + "4" * 17 + "5" * 36 + "6" * 12 + "7" * 12
    )
    heavy_region = (
        "1" * 30 + "2" * 10 + "3" * 11 + "4" * 15 + "5" * 38 + "6" * 12 + "7" * 12
    )
    for reg in [light_region, heavy_region]:
        assert len(reg) == 128

    return {"H": heavy_region, "L": light_region}


def define_north_regions() -> Dict[str, str]:
    light_region = (
        "1" * 23 + "2" * 17 + "3" * 14 + "4" * 15 + "5" * 35 + "6" * 13 + "7" * 11
    )
    heavy_region = (
        "1" * 23 + "2" * 17 + "3" * 14 + "4" * 12 + "5" * 38 + "6" * 13 + "7" * 11
    )
    for reg in [light_region, heavy_region]:
        assert len(reg) == 128

    return {"H": heavy_region, "L": light_region}


_regions = {}
for scheme, define_function in [
    ("imgt", define_imgt_regions),
    ("chothia", define_chothia_regions),
    ("kabat", define_kabat_regions),
    ("north", define_north_regions),
    ("contact", define_contact_regions),
]:
    _regions[scheme] = define_function()

# For internal use only. These are not direct conversions and are handled heuristically.
_index_to_imgt_state = {
    ("chothia", "H"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 6,
        7: 7,
        8: 8,
        9: 9,
        10: 10,
        11: 11,
        12: 12,
        13: 13,
        14: 14,
        15: 15,
        16: 16,
        17: 17,
        18: 18,
        19: 19,
        20: 20,
        21: 21,
        22: 22,
        23: 23,
        24: 24,
        25: 25,
        26: 26,
        27: 27,
        28: 28,
        29: 29,
        30: 30,
        31: 35,
        32: 36,
        33: 37,
        34: 38,
        35: 39,
        36: 40,
        37: 41,
        38: 42,
        39: 43,
        40: 44,
        41: 45,
        42: 46,
        43: 47,
        44: 48,
        45: 49,
        46: 50,
        47: 51,
        48: 52,
        49: 53,
        50: 54,
        51: 55,
        52: 59,
        53: 60,
        54: 61,
        55: 62,
        56: 63,
        57: 64,
        58: 65,
        59: 66,
        60: 67,
        61: 68,
        62: 69,
        63: 70,
        64: 72,
        65: 73,
        66: 74,
        67: 75,
        68: 76,
        69: 77,
        70: 78,
        71: 79,
        72: 80,
        73: 81,
        74: 82,
        75: 83,
        76: 84,
        77: 85,
        78: 86,
        79: 87,
        80: 88,
        81: 89,
        82: 93,
        83: 94,
        84: 95,
        85: 96,
        86: 97,
        87: 98,
        88: 99,
        89: 100,
        90: 101,
        91: 102,
        92: 103,
        93: 104,
        94: 105,
        95: 106,
        96: 107,
        97: 108,
        98: 109,
        99: 110,
        100: 114,
        101: 115,
        102: 116,
        103: 117,
        104: 118,
        105: 119,
        106: 120,
        107: 121,
        108: 122,
        109: 123,
        110: 124,
        111: 125,
        112: 126,
        113: 127,
    },
    ("kabat", "H"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 6,
        7: 7,
        8: 8,
        9: 9,
        10: 10,
        11: 11,
        12: 12,
        13: 13,
        14: 14,
        15: 15,
        16: 16,
        17: 17,
        18: 18,
        19: 19,
        20: 20,
        21: 21,
        22: 22,
        23: 23,
        24: 24,
        25: 25,
        26: 26,
        27: 27,
        28: 28,
        29: 29,
        30: 30,
        31: 31,
        32: 32,
        33: 33,
        34: 34,
        35: 35,
        36: 40,
        37: 41,
        38: 42,
        39: 43,
        40: 44,
        41: 45,
        42: 46,
        43: 47,
        44: 48,
        45: 49,
        46: 50,
        47: 51,
        48: 52,
        49: 53,
        50: 54,
        51: 55,
        52: 59,
        53: 60,
        54: 61,
        55: 62,
        56: 63,
        57: 64,
        58: 65,
        59: 66,
        60: 67,
        61: 68,
        62: 69,
        63: 70,
        64: 72,
        65: 73,
        66: 74,
        67: 75,
        68: 76,
        69: 77,
        70: 78,
        71: 79,
        72: 80,
        73: 81,
        74: 82,
        75: 83,
        76: 84,
        77: 85,
        78: 86,
        79: 87,
        80: 88,
        81: 89,
        82: 93,
        83: 94,
        84: 95,
        85: 96,
        86: 97,
        87: 98,
        88: 99,
        89: 100,
        90: 101,
        91: 102,
        92: 103,
        93: 104,
        94: 105,
        95: 106,
        96: 107,
        97: 108,
        98: 109,
        99: 110,
        100: 114,
        101: 115,
        102: 116,
        103: 117,
        104: 118,
        105: 119,
        106: 120,
        107: 121,
        108: 122,
        109: 123,
        110: 124,
        111: 125,
        112: 126,
        113: 127,
    },
    ("imgt", "H"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 5,
        7: 6,
        8: 7,
        9: 8,
        10: 9,
        11: 10,
        12: 11,
        13: 12,
        14: 13,
        15: 14,
        16: 15,
        17: 16,
        18: 17,
        19: 18,
        20: 19,
        21: 20,
        22: 21,
        23: 22,
        24: 23,
        25: 24,
        26: 25,
        27: 26,
        28: 27,
        29: 28,
        30: 29,
        31: 30,
        32: 31,
        33: 32,
        34: 33,
        35: 34,
        36: 35,
        37: 36,
        38: 37,
        39: 38,
        40: 39,
        41: 40,
        42: 41,
        43: 42,
        44: 43,
        45: 44,
        46: 45,
        47: 46,
        48: 47,
        49: 48,
        50: 49,
        51: 50,
        52: 51,
        53: 52,
        54: 53,
        55: 54,
        56: 55,
        57: 56,
        58: 57,
        59: 58,
        60: 59,
        61: 60,
        62: 61,
        63: 62,
        64: 63,
        65: 64,
        66: 65,
        67: 66,
        68: 67,
        69: 68,
        70: 69,
        71: 70,
        72: 71,
        73: 72,
        74: 73,
        75: 74,
        76: 75,
        77: 76,
        78: 77,
        79: 78,
        80: 79,
        81: 80,
        82: 81,
        83: 82,
        84: 83,
        85: 84,
        86: 85,
        87: 86,
        88: 87,
        89: 88,
        90: 89,
        91: 90,
        92: 91,
        93: 92,
        94: 93,
        95: 94,
        96: 95,
        97: 96,
        98: 97,
        99: 98,
        100: 99,
        101: 100,
        102: 101,
        103: 102,
        104: 103,
        105: 104,
        106: 105,
        107: 106,
        108: 107,
        109: 108,
        110: 109,
        111: 110,
        112: 111,
        113: 112,
        114: 113,
        115: 114,
        116: 115,
        117: 116,
        118: 117,
        119: 118,
        120: 119,
        121: 120,
        122: 121,
        123: 122,
        124: 123,
        125: 124,
        126: 125,
        127: 126,
        128: 127,
    },
    ("chothia", "L"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 5,
        7: 6,
        8: 7,
        9: 8,
        10: 9,
        11: 10,
        12: 11,
        13: 12,
        14: 13,
        15: 14,
        16: 15,
        17: 16,
        18: 17,
        19: 18,
        20: 19,
        21: 20,
        22: 21,
        23: 22,
        24: 23,
        25: 24,
        26: 25,
        27: 26,
        28: 27,
        29: 28,
        30: 35,
        31: 36,
        32: 37,
        33: 38,
        34: 39,
        35: 40,
        36: 41,
        37: 42,
        38: 43,
        39: 44,
        40: 45,
        41: 46,
        42: 47,
        43: 48,
        44: 49,
        45: 50,
        46: 51,
        47: 52,
        48: 53,
        49: 54,
        50: 55,
        51: 56,
        52: 57,
        53: 65,
        54: 66,
        55: 67,
        56: 68,
        57: 69,
        58: 70,
        59: 72,
        60: 73,
        61: 74,
        62: 75,
        63: 76,
        64: 77,
        65: 78,
        66: 81,
        67: 82,
        68: 83,
        69: 84,
        70: 85,
        71: 86,
        72: 87,
        73: 88,
        74: 89,
        75: 90,
        76: 91,
        77: 92,
        78: 93,
        79: 94,
        80: 95,
        81: 96,
        82: 97,
        83: 98,
        84: 99,
        85: 100,
        86: 101,
        87: 102,
        88: 103,
        89: 104,
        90: 105,
        91: 106,
        92: 107,
        93: 108,
        94: 109,
        95: 114,
        96: 115,
        97: 116,
        98: 117,
        99: 118,
        100: 119,
        101: 120,
        102: 121,
        103: 122,
        104: 123,
        105: 124,
        106: 125,
        107: 126,
        108: 127,
    },
    ("martin", "H"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 5,
        7: 6,
        8: 8,
        9: 9,
        10: 10,
        11: 11,
        12: 12,
        13: 13,
        14: 14,
        15: 15,
        16: 16,
        17: 17,
        18: 18,
        19: 19,
        20: 20,
        21: 21,
        22: 22,
        23: 23,
        24: 24,
        25: 25,
        26: 26,
        27: 27,
        28: 28,
        29: 29,
        30: 30,
        31: 35,
        32: 36,
        33: 37,
        34: 38,
        35: 39,
        36: 40,
        37: 41,
        38: 42,
        39: 43,
        40: 44,
        41: 45,
        42: 46,
        43: 47,
        44: 48,
        45: 49,
        46: 50,
        47: 51,
        48: 52,
        49: 53,
        50: 54,
        51: 55,
        52: 59,
        53: 60,
        54: 61,
        55: 62,
        56: 63,
        57: 64,
        58: 65,
        59: 66,
        60: 67,
        61: 68,
        62: 69,
        63: 70,
        64: 72,
        65: 73,
        66: 74,
        67: 75,
        68: 76,
        69: 77,
        70: 78,
        71: 79,
        72: 83,
        73: 84,
        74: 85,
        75: 86,
        76: 87,
        77: 88,
        78: 89,
        79: 90,
        80: 91,
        81: 92,
        82: 93,
        83: 94,
        84: 95,
        85: 96,
        86: 97,
        87: 98,
        88: 99,
        89: 100,
        90: 101,
        91: 102,
        92: 103,
        93: 104,
        94: 105,
        95: 106,
        96: 107,
        97: 108,
        98: 109,
        99: 110,
        100: 114,
        101: 115,
        102: 116,
        103: 117,
        104: 118,
        105: 119,
        106: 120,
        107: 121,
        108: 122,
        109: 123,
        110: 124,
        111: 125,
        112: 126,
        113: 127,
    },
    ("kabat", "L"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 5,
        7: 6,
        8: 7,
        9: 8,
        10: 9,
        11: 10,
        12: 11,
        13: 12,
        14: 13,
        15: 14,
        16: 15,
        17: 16,
        18: 17,
        19: 18,
        20: 19,
        21: 20,
        22: 21,
        23: 22,
        24: 23,
        25: 24,
        26: 25,
        27: 32,
        28: 33,
        29: 34,
        30: 35,
        31: 36,
        32: 37,
        33: 38,
        34: 39,
        35: 40,
        36: 41,
        37: 42,
        38: 43,
        39: 44,
        40: 45,
        41: 46,
        42: 47,
        43: 48,
        44: 49,
        45: 50,
        46: 51,
        47: 52,
        48: 53,
        49: 54,
        50: 55,
        51: 56,
        52: 57,
        53: 65,
        54: 66,
        55: 67,
        56: 68,
        57: 69,
        58: 70,
        59: 72,
        60: 73,
        61: 74,
        62: 75,
        63: 76,
        64: 77,
        65: 78,
        66: 81,
        67: 82,
        68: 83,
        69: 84,
        70: 85,
        71: 86,
        72: 87,
        73: 88,
        74: 89,
        75: 90,
        76: 91,
        77: 92,
        78: 93,
        79: 94,
        80: 95,
        81: 96,
        82: 97,
        83: 98,
        84: 99,
        85: 100,
        86: 101,
        87: 102,
        88: 103,
        89: 104,
        90: 105,
        91: 106,
        92: 107,
        93: 108,
        94: 109,
        95: 114,
        96: 115,
        97: 116,
        98: 117,
        99: 118,
        100: 119,
        101: 120,
        102: 121,
        103: 122,
        104: 123,
        105: 124,
        106: 125,
        107: 126,
        108: 127,
    },
    ("imgt", "L"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 5,
        7: 6,
        8: 7,
        9: 8,
        10: 9,
        11: 10,
        12: 11,
        13: 12,
        14: 13,
        15: 14,
        16: 15,
        17: 16,
        18: 17,
        19: 18,
        20: 19,
        21: 20,
        22: 21,
        23: 22,
        24: 23,
        25: 24,
        26: 25,
        27: 26,
        28: 27,
        29: 28,
        30: 29,
        31: 30,
        32: 31,
        33: 32,
        34: 33,
        35: 34,
        36: 35,
        37: 36,
        38: 37,
        39: 38,
        40: 39,
        41: 40,
        42: 41,
        43: 42,
        44: 43,
        45: 44,
        46: 45,
        47: 46,
        48: 47,
        49: 48,
        50: 49,
        51: 50,
        52: 51,
        53: 52,
        54: 53,
        55: 54,
        56: 55,
        57: 56,
        58: 57,
        59: 58,
        60: 59,
        61: 60,
        62: 61,
        63: 62,
        64: 63,
        65: 64,
        66: 65,
        67: 66,
        68: 67,
        69: 68,
        70: 69,
        71: 70,
        72: 71,
        73: 72,
        74: 73,
        75: 74,
        76: 75,
        77: 76,
        78: 77,
        79: 78,
        80: 79,
        81: 80,
        82: 81,
        83: 82,
        84: 83,
        85: 84,
        86: 85,
        87: 86,
        88: 87,
        89: 88,
        90: 89,
        91: 90,
        92: 91,
        93: 92,
        94: 93,
        95: 94,
        96: 95,
        97: 96,
        98: 97,
        99: 98,
        100: 99,
        101: 100,
        102: 101,
        103: 102,
        104: 103,
        105: 104,
        106: 105,
        107: 106,
        108: 107,
        109: 108,
        110: 109,
        111: 110,
        112: 111,
        113: 112,
        114: 113,
        115: 114,
        116: 115,
        117: 116,
        118: 117,
        119: 118,
        120: 119,
        121: 120,
        122: 121,
        123: 122,
        124: 123,
        125: 124,
        126: 125,
        127: 126,
        128: 127,
    },
    ("martin", "L"): {
        1: 0,
        2: 1,
        3: 2,
        4: 3,
        5: 4,
        6: 5,
        7: 6,
        8: 7,
        9: 8,
        10: 9,
        11: 10,
        12: 11,
        13: 12,
        14: 13,
        15: 14,
        16: 15,
        17: 16,
        18: 17,
        19: 18,
        20: 19,
        21: 20,
        22: 21,
        23: 22,
        24: 23,
        25: 24,
        26: 25,
        27: 26,
        28: 27,
        29: 28,
        30: 35,
        31: 36,
        32: 37,
        33: 38,
        34: 39,
        35: 40,
        36: 41,
        37: 42,
        38: 43,
        39: 44,
        40: 45,
        41: 46,
        42: 47,
        43: 48,
        44: 49,
        45: 50,
        46: 51,
        47: 52,
        48: 53,
        49: 54,
        50: 55,
        51: 56,
        52: 57,
        53: 65,
        54: 66,
        55: 67,
        56: 68,
        57: 69,
        58: 70,
        59: 72,
        60: 73,
        61: 74,
        62: 75,
        63: 76,
        64: 77,
        65: 78,
        66: 81,
        67: 82,
        68: 83,
        69: 84,
        70: 85,
        71: 86,
        72: 87,
        73: 88,
        74: 89,
        75: 90,
        76: 91,
        77: 92,
        78: 93,
        79: 94,
        80: 95,
        81: 96,
        82: 97,
        83: 98,
        84: 99,
        85: 100,
        86: 101,
        87: 102,
        88: 103,
        89: 104,
        90: 105,
        91: 106,
        92: 107,
        93: 108,
        94: 109,
        95: 114,
        96: 115,
        97: 116,
        98: 117,
        99: 118,
        100: 119,
        101: 120,
        102: 121,
        103: 122,
        104: 123,
        105: 124,
        106: 125,
        107: 126,
        108: 127,
    },
}

# Wolfguy will be deprecated in ANARCI v1.0.0
wolfguy_indexdiv50_to_region = {
    "H": ["fwh1", "cdrh1", "fwh2", "cdrh2", "fwh3", "cdrh3", "fwh4"],
    "L": ["fwl1", "cdrl1", "fwl2", "cdrl2", "fwl3", "cdrl3", "fwl4"],
}
